<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nyapa.ai - Smart WhatsApp Bot Demo</title>
    <!-- Tailwind CSS with Dark Mode Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'wa-dark-bg': '#0b141a',
                        'wa-dark-header': '#202c33',
                        'wa-dark-msg-in': '#202c33',
                        'wa-dark-msg-out': '#005c4b',
                        'wa-dark-input': '#2a3942',
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #374045; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .bg-wa-beige {
            background-color: #efeae2;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay;
            background-size: 400px;
        }

        .dark .bg-wa-beige {
            background-color: #0b141a;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: soft-light;
            opacity: 1;
        }

        .bg-wa-teal { background-color: #008069; }
        .bg-wa-dark-teal { background-color: #005c4b; }
        .bg-wa-user-green { background-color: #d9fdd3; }
        
        .dot-flashing {
            position: relative;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #9ca3af;
            color: #9ca3af;
            animation: dot-flashing 1s infinite linear alternate;
            animation-delay: 0.5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: "";
            display: inline-block;
            position: absolute;
            top: 0;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #9ca3af;
            color: #9ca3af;
            animation: dot-flashing 1s infinite alternate;
        }
        .dot-flashing::before { left: -10px; animation-delay: 0s; }
        .dot-flashing::after { left: 10px; animation-delay: 1s; }
        
        @keyframes dot-flashing {
            0% { background-color: #9ca3af; }
            50%, 100% { background-color: #e5e7eb; }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 h-[100dvh] w-full flex items-center justify-center font-sans overflow-hidden fixed inset-0 transition-colors duration-300">

    <div class="relative w-full h-full md:w-[400px] md:h-[90vh] md:max-h-[850px] md:rounded-3xl md:shadow-2xl overflow-hidden flex flex-col bg-wa-beige transition-all duration-300 border-0 md:border md:border-gray-200 dark:md:border-gray-700">
        
        <!-- Header -->
        <div class="bg-wa-teal dark:bg-wa-dark-header p-3 flex items-center justify-between text-white z-20 shadow-sm flex-shrink-0 transition-colors duration-300">
            <div class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 cursor-pointer md:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                
                <div class="relative">
                    <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-wa-teal font-bold text-lg overflow-hidden">
                        <img src="https://github.com/LanggamXD/Nyapa.ai/blob/main/yapa.AI_20251129_210519_0000.png?raw=true" alt="Nyapa Logo" class="w-full h-full object-cover">
                    </div>
                    <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-400 rounded-full border-2 border-wa-teal dark:border-wa-dark-header"></div>
                </div>

                <div class="flex flex-col">
                    <div class="flex items-center gap-1">
                        <h1 class="font-semibold text-lg leading-tight">Nyapa.ai Demo</h1>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-300" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <span class="text-xs text-gray-200 animate-pulse" id="status-text">Online</span>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <button onclick="toggleDarkMode()" class="p-2 hover:bg-black/10 rounded-full transition text-white">
                    <svg id="icon-sun" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <svg id="icon-moon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>

                <button onclick="toggleAdminModal()" class="p-2 hover:bg-black/10 rounded-full transition relative group">
                     <span class="absolute top-1 right-1 flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                    </span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-3 relative scroll-smooth overscroll-contain">
            <div class="flex justify-center mb-4">
                <div class="bg-[#ffeb3b] dark:bg-yellow-900/50 bg-opacity-40 dark:text-yellow-200 text-[11px] text-gray-700 px-3 py-1 rounded-lg text-center shadow-sm backdrop-blur-sm transition-colors">
                    üîí Pesan terenkripsi secara end-to-end.
                </div>
            </div>

            <!-- Welcome Message -->
            <div class="flex justify-start">
                <div class="bg-white dark:bg-wa-dark-msg-in rounded-lg rounded-tl-none p-2.5 px-3 max-w-[85%] shadow-[0_1px_0.5px_rgba(0,0,0,0.13)] relative transition-colors">
                    <p class="text-[14.2px] leading-snug text-[#111b21] dark:text-gray-100">Hai kak! üëã<br>Selamat datang di <b>Sapa Sepatu</b>.<br><br>Aku <b>Naya</b>, siap bantu kakak cari sepatu yang paling pas üòä<br>Kakak lagi cari sepatu running, sneakers casual, atau mau lihat rekomendasi dulu?</p>
                    <span class="text-[11px] text-[#667781] dark:text-gray-400 block text-right mt-1 leading-none">10:00</span>
                </div>
            </div>
            <!-- Messages injected here -->
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden absolute bottom-[110px] left-4 bg-white dark:bg-wa-dark-header px-4 py-2 rounded-full shadow-md z-10 transition-all">
            <div class="flex items-center gap-2"><div class="dot-flashing ml-2"></div></div>
        </div>

        <!-- Footer Section: Suggestions + Input -->
        <div class="bg-[#f0f2f5] dark:bg-wa-dark-header z-10 flex flex-col flex-shrink-0 transition-colors duration-300">
            <!-- Dynamic Suggestions -->
            <div id="suggestion-container" class="flex gap-2 overflow-x-auto p-2 pt-3 no-scrollbar whitespace-nowrap px-4 cursor-grab active:cursor-grabbing">
               <!-- Suggestions injected via JS -->
            </div>

            <!-- Input Area -->
            <div class="p-2 flex items-end gap-2 pb-3 md:pb-3 pb-[max(12px,env(safe-area-inset-bottom))]">
                <div class="flex-1 bg-white dark:bg-wa-dark-input rounded-3xl flex items-center shadow-sm border-none px-3 py-1 transition-colors">
                     <textarea id="user-input" rows="1" placeholder="Ketik pesan..." 
                        class="flex-1 p-2 bg-transparent border-none focus:outline-none text-[15px] text-[#111b21] dark:text-white resize-none max-h-24 leading-snug placeholder-gray-500 dark:placeholder-gray-400"
                        style="scrollbar-width: none;"
                        onkeypress="handleEnter(event)"></textarea>
                </div>
                <button onclick="sendMessage()" class="bg-wa-teal dark:bg-wa-dark-teal p-3 rounded-full text-white hover:opacity-90 transition shadow-sm transform active:scale-95 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- ADMIN MODAL -->
        <div id="admin-modal" class="absolute inset-0 bg-black bg-opacity-60 z-50 hidden flex items-end md:items-center justify-center backdrop-blur-sm transition-all">
            <div class="bg-[#f0f2f5] dark:bg-gray-800 w-full md:w-[95%] md:rounded-2xl rounded-t-2xl overflow-hidden shadow-2xl h-[90vh] md:h-auto max-h-[90vh] flex flex-col transition-colors">
                 <div class="bg-wa-teal dark:bg-wa-dark-header p-4 text-white flex justify-between items-center shrink-0">
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
                        Dashboard Admin
                    </h2>
                    <button onclick="toggleAdminModal()" class="text-white hover:bg-white/20 rounded-full p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                </div>

                <div class="p-4 overflow-y-auto flex-1 dark:text-gray-200">
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-xl shadow-sm border border-gray-200 dark:border-gray-600 mb-4 shrink-0 transition-colors">
                        <h3 class="text-sm font-bold text-wa-teal dark:text-teal-400 mb-3 flex justify-between items-center">
                            <span id="form-title">Tambah Produk Baru</span>
                            <button id="cancel-edit-btn" onclick="cancelEdit()" class="hidden text-xs text-red-500 hover:underline">Cancel Edit</button>
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <input type="text" id="prod-img" placeholder="URL Gambar (cth: https://i.imgur.com/...)" class="w-full p-2.5 text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-600 border rounded-lg focus:outline-none focus:border-wa-teal focus:ring-1 focus:ring-wa-teal transition bg-gray-50 dark:text-white">
                                <p class="text-[10px] text-gray-400 mt-1 ml-1">*Kosongkan untuk pakai gambar default</p>
                            </div>
                            
                            <input type="text" id="prod-name" placeholder="Nama Produk (cth. Kemeja Flanel)" class="w-full p-2.5 text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-600 border rounded-lg focus:outline-none focus:border-wa-teal focus:ring-1 focus:ring-wa-teal transition dark:text-white">
                            
                            <div class="flex gap-2 sm:flex-row flex-col">
                                <input type="text" id="prod-price" placeholder="Harga/Info (cth. 150rb, Size L)" class="w-full p-2.5 text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-600 border rounded-lg focus:outline-none focus:border-wa-teal focus:ring-1 focus:ring-wa-teal transition dark:text-white">
                                <button id="save-prod-btn" onclick="saveProduct()" class="bg-wa-teal dark:bg-teal-600 text-white px-6 py-2.5 rounded-lg text-sm font-bold hover:opacity-90 transition flex items-center justify-center gap-1 sm:w-auto w-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                    <span id="save-btn-text">Simpan</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-[11px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2 px-1">Knowledge Base Saat Ini</h3>
                        <div id="product-list" class="space-y-2 pb-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION & STATE ---
        // API KEY TELAH DIHAPUS - DIGANTIKAN OLEH BACKEND (Vercel)
        
        let products = [
            { id: 1, name: "SwiftRun Lite", price: "280k", info: "Ringan & empuk, cocok buat jogging harian.", sizes: "41, 42", image: "https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=400&q=80" },
            { id: 2, name: "AeroPulse Runner", price: "320k", info: "Material breathable, kaki adem waktu lari.", sizes: "40, 41, 42, 43", image: "https://images.unsplash.com/photo-1491553895911-0055eca6402d?w=400&q=80" },
            { id: 3, name: "UrbanFlex Motion", price: "300k", info: "Nyaman buat daily running & jalan santai.", sizes: "40, 43", image: "https://images.unsplash.com/photo-1606107557195-0e29a4b5b4aa?w=400&q=80" },
            { id: 4, name: "PrimeShift Runner", price: "350k", info: "Premium, stabil, favorit untuk olahraga rutin.", sizes: "43, 44, 45", image: "https://images.unsplash.com/photo-1514989940723-e8e51635b782?w=400&q=80" }
        ];

        const storeInfo = {
            name: "Sapa Sepatu",
            hours: "Senin - Sabtu, 09.00 - 17.00 WIB",
            location: "Jl. Prajurit Syakur no 20, Banyuwangi",
            shipping: "Gratis Ongkir untuk pembelian diatas 250k. JNE, J&T.",
            payment_methods: "BCA, Mandiri, BNI, DANA, OVO, GoPay, QRIS, COD"
        };

        let editingProductId = null;
        let isTyping = false;
        let currentSuggestions = ["Cari sepatu running", "Ada sepatu casual?", "Liat rekomendasi dong", "Cek ukuran 43"];

        // --- 2. DOM ELEMENTS ---
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const productListEl = document.getElementById('product-list');
        const adminModal = document.getElementById('admin-modal');
        const loadingIndicator = document.getElementById('loading-indicator');
        const suggestionContainer = document.getElementById('suggestion-container');
        const statusText = document.getElementById('status-text');
        
        const formTitle = document.getElementById('form-title');
        const prodNameInput = document.getElementById('prod-name');
        const prodPriceInput = document.getElementById('prod-price');
        const prodImgInput = document.getElementById('prod-img'); 
        const saveProdBtn = document.getElementById('save-prod-btn');
        const saveBtnText = document.getElementById('save-btn-text');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        
        const iconSun = document.getElementById('icon-sun');
        const iconMoon = document.getElementById('icon-moon');

        // --- 3. HELPER FUNCTIONS ---

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            if (isDark) {
                iconSun.classList.remove('hidden');
                iconMoon.classList.add('hidden');
            } else {
                iconSun.classList.add('hidden');
                iconMoon.classList.remove('hidden');
            }
        }
        
        function renderProductList() {
            productListEl.innerHTML = '';
            if(products.length === 0) {
                 productListEl.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">Belum ada produk.</div>';
                 return;
            }
            products.forEach((p) => {
                const imgUrl = p.image || "https://placehold.co/100?text=No+Img";
                const sizeInfo = p.sizes ? `Size: ${p.sizes}` : '';

                const item = document.createElement('div');
                item.className = "flex justify-between items-start bg-white dark:bg-gray-700 p-3 rounded-xl border border-gray-100 dark:border-gray-600 shadow-sm group hover:border-wa-teal transition-colors";
                item.innerHTML = `
                    <div class="flex items-center gap-3 flex-1 overflow-hidden">
                        <div class="w-12 h-12 bg-gray-100 dark:bg-gray-600 rounded-lg flex-shrink-0 overflow-hidden border border-gray-200 dark:border-gray-500">
                            <img src="${imgUrl}" alt="${p.name}" class="w-full h-full object-cover">
                        </div>
                        <div class="min-w-0">
                            <div class="font-semibold text-gray-800 dark:text-gray-100 text-[15px] truncate">${p.name}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-300 mt-0.5 truncate">${p.price} <span class="text-gray-400 mx-1">‚Ä¢</span> <span class="text-xs">${p.info}</span></div>
                             <div class="text-[10px] text-gray-400 dark:text-gray-500 mt-0.5">${sizeInfo}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-1 opacity-60 group-hover:opacity-100 transition-opacity ml-2">
                        <button onclick="startEditProduct(${p.id})" class="p-2 text-gray-500 dark:text-gray-400 hover:text-wa-teal dark:hover:text-teal-400 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-full transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                        </button>
                        <button onclick="deleteProduct(${p.id})" class="p-2 text-gray-400 dark:text-gray-500 hover:text-red-500 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-full transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                `;
                productListEl.appendChild(item);
            });
        }

        function renderSuggestions(list = currentSuggestions) {
            suggestionContainer.innerHTML = '';
            list.forEach(text => {
                const chip = document.createElement('button');
                chip.className = "px-3 py-1.5 bg-white dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600 border border-gray-200 rounded-full text-[13px] text-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 hover:border-wa-teal transition flex-shrink-0 shadow-sm active:scale-95 animate-[fadeIn_0.5s_ease-out]";
                chip.textContent = text;
                chip.onclick = () => sendSuggestion(text);
                suggestionContainer.appendChild(chip);
            });
        }

        function createTime() {
            const now = new Date();
            return now.getHours() + ":" + String(now.getMinutes()).padStart(2, '0');
        }

        function appendMessage(text, isUser) {
            const div = document.createElement('div');
            div.className = `flex ${isUser ? 'justify-end' : 'justify-start'} mb-3 animate-[fadeIn_0.3s_ease-in-out]`;
            
            const bubbleColor = isUser ? 'bg-[#d9fdd3] dark:bg-wa-dark-msg-out' : 'bg-white dark:bg-wa-dark-msg-in';
            const borderRadius = isUser ? 'rounded-tr-none' : 'rounded-tl-none';
            const checkmark = isUser ? `<span class="ml-1 text-[#53bdeb]">‚úì‚úì</span>` : '';
            const textColor = text.startsWith("‚ö†Ô∏è") ? 'text-red-600' : 'text-[#111b21] dark:text-gray-100';
            
            let formattedText = text.replace(/(https?:\/\/[^\s]+)/g, (url) => {
                if(url.match(/\.(jpeg|jpg|gif|png|webp)$/) != null || url.includes('unsplash') || url.includes('placehold') || url.includes('img.susercontent')) {
                    return `<br><img src="${url}" class="rounded-lg mt-2 w-full max-w-[250px] object-cover border border-gray-200 dark:border-gray-600 cursor-pointer hover:opacity-90 transition">`;
                }
                return `<a href="${url}" target="_blank" class="text-blue-500 hover:underline break-all">${url}</a>`;
            });

            div.innerHTML = `
                <div class="${bubbleColor} rounded-lg ${borderRadius} p-2.5 px-3 max-w-[85%] shadow-[0_1px_0.5px_rgba(0,0,0,0.13)] relative ${textColor} text-[14.2px] leading-snug">
                    <p>${formattedText.replace(/\n/g, '<br>')}</p>
                    <div class="flex justify-end items-center gap-1 mt-1 relative -bottom-0.5">
                        <span class="text-[11px] text-[#667781] dark:text-gray-400 leading-none">${createTime()}</span>
                        ${checkmark}
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(div);
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }
        
        // --- ADMIN FUNCTIONS ---
        function toggleAdminModal() {
            adminModal.classList.toggle('hidden');
            if(!adminModal.classList.contains('hidden')){ renderProductList(); cancelEdit(); }
        }

        function saveProduct() {
            const name = prodNameInput.value.trim();
            const priceInfo = prodPriceInput.value.trim();
            const imgUrl = prodImgInput.value.trim();
            if (!name || !priceInfo) return alert("Mohon isi Nama Produk dan Harga/Info.");
            if (editingProductId) {
                const product = products.find(p => p.id === editingProductId);
                if(product) { product.name = name; const parts = priceInfo.split(',').map(s => s.trim()); product.price = parts[0] || priceInfo; product.info = parts.slice(1).join(', ') || "Updated"; product.image = imgUrl; }
            } else {
                 const parts = priceInfo.split(',').map(s => s.trim());
                products.push({ id: Date.now(), name: name, price: parts[0] || priceInfo, info: parts.slice(1).join(', ') || "New", image: imgUrl });
            }
            cancelEdit(); renderProductList(); toggleAdminModal(); 
            appendMessage("‚úÖ *System:* Database produk berhasil diperbarui oleh Admin.", false);
        }

        function deleteProduct(id) {
            if(confirm("Yakin hapus?")) { products = products.filter(p => p.id !== id); renderProductList(); if (editingProductId === id) cancelEdit(); }
        }

        function startEditProduct(id) {
            const product = products.find(p => p.id === id); if(!product) return;
            editingProductId = id; formTitle.textContent = `Edit Produk: ${product.name}`; prodNameInput.value = product.name; prodPriceInput.value = `${product.price}, ${product.info}`; prodImgInput.value = product.image || ""; 
            saveBtnText.textContent = "Update"; saveProdBtn.classList.replace('bg-wa-teal', 'bg-blue-600'); cancelEditBtn.classList.remove('hidden'); prodNameInput.focus();
        }

        function cancelEdit() {
            editingProductId = null; formTitle.textContent = "Tambah Produk"; prodNameInput.value = ''; prodPriceInput.value = ''; prodImgInput.value = ''; 
            saveBtnText.textContent = "Simpan"; saveProdBtn.classList.replace('bg-blue-600', 'bg-wa-teal'); cancelEditBtn.classList.add('hidden');
        }

        // --- 5. CHAT & AI LOGIC (SECURE BACKEND CALL) ---

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
            e.target.style.height = 'auto'; e.target.style.height = e.target.scrollHeight + 'px';
        }

        function sendSuggestion(text) {
            userInput.value = text; userInput.style.height = 'auto'; sendMessage();
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text || isTyping) return;

            isTyping = true;
            appendMessage(text, true);
            userInput.value = '';
            userInput.style.height = 'auto'; 
            loadingIndicator.classList.remove('hidden');
            statusText.textContent = "typing...";
            suggestionContainer.innerHTML = '';

            try {
                // Construct context in frontend (so dynamic products work)
                const dbContext = { products: products, store_information: storeInfo };
                const dbString = JSON.stringify(dbContext);
                
                const systemPrompt = `
                    **IDENTITY:**
                    Anda adalah "Naya", asisten virtual ramah dari "Sapa Sepatu".
                    Tujuan: Membantu pelanggan mencari sepatu, menjelaskan perbedaan produk, mengecek stok, dan memandu pembayaran.
                    Tone: Casual, Emoticon friendly, Sopan (Gunakan 'Kak').
                    
                    **DATABASE & FAKTA (WAJIB DIPATUHI):**
                    ${dbString}
                    
                    **ATURAN KHUSUS GAMBAR:**
                    - Jika user meminta LIHAT gambar/foto produk, dan ada URL di data, WAJIB KIRIM LINK GAMBARNYA.
                    
                    **ALUR & RESPON:**
                    1. Greeting & Value: Sambut, tanya kebutuhan.
                    2. Rekomendasi: Tawarkan SwiftRun/AeroPulse untuk running.
                    3. Edukasi: Jelaskan beda produk.
                    4. Cek Ukuran: SwiftRun (41,42), AeroPulse (40-43).
                    5. Alternatif: UrbanFlex/PrimeShift untuk size 43+.
                    6. Closing: Konfirmasi pesanan, Minta alamat, Info Ongkir Gratis, Pembayaran (BCA 1234567890).

                    **FORMAT RESPON JSON:**
                    {
                        "reply": "Isi balasan Naya",
                        "suggestions": ["Saran 1", "Saran 2"]
                    }
                `;

                // CALL BACKEND VERCEL
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: text,
                        systemPrompt: systemPrompt
                    })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                
                const rawText = data.candidates[0].content.parts[0].text;
                let result;
                try {
                     result = JSON.parse(rawText);
                } catch (e) {
                     result = { reply: rawText, suggestions: [] };
                }

                appendMessage(result.reply, false);
                
                if(result.suggestions && Array.isArray(result.suggestions)) {
                    renderSuggestions(result.suggestions);
                }

            } catch (error) {
                console.error(error);
                appendMessage("‚ö†Ô∏è Maaf, Naya lagi pusing dikit (Server Error). Coba lagi ya kak!", false);
                renderSuggestions(["Coba Lagi", "Menu Utama"]); 
            } finally {
                loadingIndicator.classList.add('hidden');
                statusText.textContent = "Online";
                isTyping = false;
            }
        }

        renderSuggestions();
        
        const style = document.createElement('style');
        style.innerHTML = `@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }`;
        document.head.appendChild(style);
    </script>
</body>
</html>